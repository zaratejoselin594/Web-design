<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detalles del Pedido</title>
  <link rel="stylesheet" href="./main/main.css">
  <link rel="stylesheet" href="./main/normalize.css">
</head>

<body>
  <h1>Detalles de tu Pedido</h1>
  <div id="orderDetails"></div>

  <script>
  document.addEventListener('DOMContentLoaded', function () {
    const urlParams = new URLSearchParams(window.location.search);
    const orderID = urlParams.get('order');

    if (!orderID) {
      document.getElementById('orderDetails').innerHTML = "<p>No se proporcionó un ID de pedido.</p>";
      return;
    }

    // Recuperar los datos del pedido desde localStorage
    const orderDataJSON = localStorage.getItem('pedido_' + orderID);

    if (!orderDataJSON) {
      document.getElementById('orderDetails').innerHTML = "<p>No se encontró el pedido.</p>";
      console.warn(`Pedido con ID '${orderID}' no encontrado en localStorage.`);
      return;
    }

    const orderData = JSON.parse(orderDataJSON);
    console.log("Pedido recuperado:", orderData);

    const clienteInfo = orderData.clienteInfo || "Información no disponible";

    // Extraer nombre y teléfono con un mejor manejo de errores
    const nombreMatch = clienteInfo.match(/\*Nombre y Apellido:\* (.+)/);
    const telefonoMatch = clienteInfo.match(/\*Teléfono 📞:\* (.+)/);

    const nombre = nombreMatch ? nombreMatch[1] : 'Nombre no disponible';
    const telefono = telefonoMatch ? telefonoMatch[1] : 'Teléfono no disponible';

    let orderDetailsHTML = `
        <h2>Pedido #${orderData.orderID}</h2>
        <h3>Datos del Cliente:</h3>
        <p><strong>Nombre:</strong> ${nombre}</p>
        <p><strong>Teléfono:</strong> ${telefono}</p>
        <h3>Detalles del Pedido:</h3>
        <ul>
    `;

    orderData.pedidos.forEach(pedido => {
      const pedidoPrice = parseFloat(pedido.price);

      orderDetailsHTML += `
            <li>
                <img src="${pedido.images?.length > 0 ? pedido.images[0] : 'default-image.jpg'}" alt="Producto" class="imgProduct">
                ${pedido.drawing ? `<img src="${pedido.drawing}" alt="Dibujo" class="imgProduct">` : ''}
                <div class="titleCart">
                    <div class="infoCart">
                        <h3>${pedido.flavor || pedido.name || 'Producto sin nombre'}</h3>
                        <p>Para ${pedido.people || 'N/A'} personas - ${pedido.grams || 'N/A'} gramos - ${pedido.decorations || 'Sin decoración'}</p>
                        <p>$${pedidoPrice.toFixed(2)}</p>
                    </div>
                </div>
            </li>
        `;
    });

    const totalPrice = parseFloat(orderData.totalPrice);
    orderDetailsHTML += `
        </ul>
        <h3>Total a Pagar: $${totalPrice.toFixed(2)}</h3>
    `;

    document.getElementById('orderDetails').innerHTML = orderDetailsHTML;
  });

  </script>
</body>

</html>